# Generated by Chef for <%= node['hostname'] %>.
# Local modifications will be overwritten.

[client]
<% if @port %>
port                           = <%= @port %>
<% end %>
<% if @socket_file %>
socket                         = <%= @socket_file %>
<% end %>

[mysqld_safe]
socket                         = <%= @socket_file %>
<% if @nice %>
nice                           = 0
<% end %>

[mysqld]
user                           = mysql
pid-file                       = <%= @pid_file %>
socket                         = <%= @socket_file %>
<% if @port %>
port                           = <%= @port %>
<% end %>
<% if @basedir %>
basedir                        = <%= @base_dir %>
<% end %>
<% if @data_dir %>
datadir                        = <%= @data_dir %>
<% end %>
<% if @tmpdir %>
tmpdir                         = /tmp
<% end %>
<% if @lc_messages_dir %>
lc-messages-dir                = <%= @lc_messages_dir %>
<% end %>

server-id                      = <%= node['ipaddress'][/\d+\.\d+\.\d+$/].gsub(/\./, '') %>
character-set-server           = utf8

log-error                      = <%= @log_dir %>/mysql.log
long_query_time                = 1
slow_query_log
slow_query_log_file            = <%= @log_dir %>/mysql-slow.log
log-slow-slave-statements

explicit_defaults_for_timestamp
skip_external_locking # for MyISAM
skip-name-resolve
default-storage-engine         = innodb

key_buffer_size                = 32M
max_allowed_packet             = 32M
max_connections                = <%= @mysql_wrapper['max_connections'] %>
max_connect_errors             = 10000
max_heap_table_size            = 64M
myisam_sort_buffer_size        = 1M
join_buffer_size               = 256K
query_cache_type               = 0
query_cache_size               = 0M
read_buffer_size               = 128K
read_rnd_buffer_size           = 256K
<% if @mysql_wrapper['table_open_cache'] %>
table_open_cache               = <%= @mysql_wrapper['table_open_cache'] %>
<% end %>
<% if @mysql_wrapper['thread_cache_size'] %>
thread_cache_size              = <%= @mysql_wrapper['thread_cache_size'] %>
<% end %>
thread_concurrency             = <%= node['cpu']['total'].to_i * 2 %>
tmp_table_size                 = 64M
sort_buffer_size               = 4M
wait_timeout                   = 180

binlog_format                  = MIXED
binlog_checksum                = CRC32 # NONE for back compatibility
<% if @mysql_wrapper['expire_logs_days'] %>
expire-logs-days               = <%= @mysql_wrapper['expire_logs_days'] %>
<% end %>
log-bin                        = mysql-bin
log-bin-index                  = mysql-bin.index 
<% if @mysql_wrapper['log_slave_updates'] %>
log_slave_updates
<% end %>
master_info_repository         = TABLE # FILE for back compatibility
max_binlog_size                = 512M
<% if @mysql_wrapper['read_only'] %>
read_only
<% end %>
sync_binlog                    = 1

<% if @mysql_wrapper['binlog_do_db'] %>
binlog-do-db                   = <%= @mysql_wrapper['binlog_do_db'] %>
<% end %>
binlog-ignore-db               = mysql
replicate_ignore-db            = mysql

relay-log                      = relay-bin
relay-log-index                = relay-index
relay-log-info-file            = relay-bin.info
relay_log_recovery
relay_log_info_repository      = TABLE

innodb_strict_mode
innodb_buffer_pool_size        = <%= @mysql_wrapper['innodb_buffer_pool_size'] %>
innodb_buffer_pool_instances   = <%= @mysql_wrapper['innodn_buffer_pool_instances'] %>
innodb_buffer_pool_load_at_startup  = 1
innodb_buffer_pool_dump_at_shutdown = 1
innodb_checksum_algorithm      = CRC32 # InnoDB for back compatibility
innodb_data_file_path          = <%= @mysql_wrapper['innodb_data_file_path'] %>
innodb_file_format             = Barracuda
innodb_file_per_table
innodb_flush_log_at_trx_commit = 1
innodb_flush_method            = O_DIRECT
innodb_data_home_dir           = <%= @data_dir %>
innodb_io_capacity             = 500
innodb_large_prefix            = 1
innodb_log_buffer_size         = 16M
innodb_log_file_size           = 512M
innodb_log_files_in_group      = 2
innodb_lock_wait_timeout       = 120
innodb_max_dirty_pages_pct     = 90
innodb_print_all_deadlocks     = 1
innodb_thread_concurrency      = <%= node['cpu']['total'].to_i * 2 %>
innodb_support_xa              = 1
innodb_read_io_threads         = 4
innodb_write_io_threads        = 4

sql_mode = NO_ENGINE_SUBSTITUTION,STRICT_TRANS_TABLES,STRICT_ALL_TABLES

[mysql]
<% if @include_dir %>
!includedir <%= @include_dir %>
<% end %>
